{% extends "layout.html" %}
{% block title %}
Agua Hefe
{% endblock %}
{% block content %}

<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->

<script>
    function changeTarget(target) {
        console.log("changeTarget:");
        console.log(target);

        // convert single quotes to JSON double quotes
        target = target.replaceAll("'", "\"")
        // convert string to JSON
        var targetjson = JSON.parse(target);

        document.getElementById("selectedProfile").value = targetjson.Style;
        document.getElementById("targetCa").value = targetjson.Ca;
        document.getElementById("targetMg").value = targetjson.Mg;
        document.getElementById("targetSO4").value = targetjson.SO4;
        document.getElementById("targetNa").value = targetjson.Na;
        document.getElementById("targetCl").value = targetjson.Cl;
        document.getElementById("targetHCO3").value = targetjson.HCO3;
		return false;
    }
</script>

<script>
    function updateDiffs() {
		// TODO
        console.log("updateDiffs:");
        document.getElementById("diffCa").value = document.getElementById("saltsCa").value - document.getElementById("targetCa").value;
        document.getElementById("diffMg").value = document.getElementById("saltsMg").value - document.getElementById("targetMg").value;
        document.getElementById("diffSO4").value = document.getElementById("saltsSO4").value - document.getElementById("targetSO4").valu;
        document.getElementById("diffNa").value = document.getElementById("saltsNa").value - document.getElementById("targetNa").valu;
        document.getElementById("diffCl").value = document.getElementById("saltsCl").value - document.getElementById("targetCl").value;
        document.getElementById("diffHCO3").value = document.getElementById("saltsHCO3").value - document.getElementById("targetHCO3").value;
		return false;
    }
</script>

<script>
    function updateAll() {
		// TODO
        console.log("updateAll:");
        console.log(ah_data.form_data);
        document.getElementById("targetCa").value = ah_data.form_data.targetCa;
        document.getElementById("targetMg").value = ah_data.form_data.targetMg;
        document.getElementById("targetSO4").value = ah_data.form_data.targetSO4;
        document.getElementById("targetNa").value = ah_data.form_data.targetNa;
        document.getElementById("targetCl").value = ah_data.form_data.targetCl;
        document.getElementById("targetHCO3").value = ah_data.form_data.targetHCO3;
        
        updateDiffs();
		return false;
    }
</script>

<script type="text/javascript">
    function calc_salts() {
		console.log("calc_salts:");

        let targetCa = document.getElementById("targetCa").value;
        let targetMg = document.getElementById("targetMg").value;
        let targetSO4 = document.getElementById("targetSO4").value;
        let targetNa = document.getElementById("targetNa").value;
        let targetCl = document.getElementById("targetCl").value;
        let targetHCO3 = document.getElementById("targetHCO3").value;
        let textMashVolume = document.getElementById("txtmashvolume").value;
        let textUnits = document.querySelector('input[name=units]:checked').value;
        // these have to line up to match the Python calc_salts method
        let target_salts = [targetCa, targetMg, targetSO4, targetNa, targetCl, targetHCO3, textMashVolume, textUnits]

        let calc_salts_url = "/calc_salts?salts=".concat(target_salts.toString())
        $.getJSON(calc_salts_url,
                    function(data) {
                        document.getElementById("txtCaCO3").value = data[0];
                        document.getElementById("txtNaHCO3").value = data[1];
                        document.getElementById("txtCaSO4").value = data[2];
                        document.getElementById("txtCaCl2").value = data[3];
                        document.getElementById("txtMgSO4").value = data[4];
                        document.getElementById("txtNaCl").value = data[5];

						adjustments();
                    }
                );
		
        return false;
    }
</script>

<script type="text/javascript">
    function adjustments() {
		// TODO: returned numbers are way off
		console.log("adjustments:");

        let txtCaCO3 = document.getElementById("txtCaCO3").value;
        let txtNaHCO3 = document.getElementById("txtNaHCO3").value;
        let txtCaSO4 = document.getElementById("txtCaSO4").value;
        let txtCaCl2 = document.getElementById("txtCaCl2").value;
        let txtMgSO4 = document.getElementById("txtMgSO4").value;
        let txtNaCl = document.getElementById("txtNaCl").value;

 		// get the gallons2units conversion multiplier
        let mashvolume = document.getElementById("txtmashvolume").value;
        let units = document.querySelector('input[name=units]:checked').value;
		let gallons_to_units = 0.0

        let units_url = "/gallons2units?mashvolume=".concat(mashvolume).concat("&units=".concat(units));
        $.getJSON(units_url,
			function(gallons_to_units) {

				// "un-convert" the values to make the math consistent
				let multiplier = 1 / gallons_to_units;
				function unconvert(text) {
					let text_as_float = parseFloat(text);
					return text_as_float * multiplier;
				}

				let target_salts = [unconvert(txtCaCO3), unconvert(txtNaHCO3), unconvert(txtCaSO4),
										unconvert(txtCaCl2), unconvert(txtMgSO4), unconvert(txtNaCl)]

				let adjustments_url = "/adjustments_from_salts?salts=".concat(target_salts.toString())
				$.getJSON(adjustments_url,
					function(data) {
						document.getElementById("saltsCa").value = data[0];
						console.log(data[0]);
						console.log(document.getElementById("saltsCa").value);

						document.getElementById("saltsMg").value = data[1];

						document.getElementById("saltsSO4").value = data[2];

						document.getElementById("saltsNa").value = data[3];

						document.getElementById("saltsCl").value = data[4];

						document.getElementById("saltsHCO3").value = data[5];

						// trigger the onChange event to update all page values
						// updateDiffs(); 						
					}
				);
			}
		);


        return false;
    }
</script>

<form action="/" method = "POST">
	<table class="calc">
			<tr>
				<td colspan="2" class="separator"><h2>Batch Data</h2></td>
			</tr>
			<tr>
				<th>Water Volume (total):</th>
				<td><input type="number" step="any" min="0" id="txtmashvolume" name="txtmashvolume" value="10" maxlength="6" style="width: 50px" onChange="javascript: updateAll();" />
				&nbsp;
				<label>
					<input type="radio" name="units" value="gallons" Checked style="background: #eeeeee; border: none;" onChange="javascript: updateAll();" />&nbsp;Gallons
				</label>
				&nbsp;&nbsp;

				<label>
					<input type="radio" name="units" value="quarts" style="background: #eeeeee; border: none;" onChange="javascript: updateAll();" />&nbsp;Quarts
				</label>
				&nbsp;&nbsp;

				<label>
					<input type="radio" name="units" value="liters" style="background: #eeeeee; border: none;" onChange="javascript: updateAll();" />&nbsp;Liters
				</label>

				</td>
			</tr>
            <!--
			<tr>
				<th>2. Percent Dilution:</th>
				<td><input type="number" step="any" min="0" name="txtdilute" value="0" maxlength="3" style="width: 50px" onChange="javascript: updateAll();" />
					<br/>
					<i>Dilute with distilled water to lower source ion concentrations.</i>
				</td>
			</tr>
            -->
			<tr>
				<th>Target Profile:</th>
				<td>
					<select name="targetprofile">
                        {% for style in ah_data.styles %}
                            <!-- <option value="{{ style.Style }} {{ style.Ca }} {{ style.Mg }} {{ style.SO4 }} {{ style.Na }} {{ style.Cl }} {{ style.HCO3 }}">{{ style.Style }}</option> -->
                            <option value="{{ style }}">{{ style.Style }}</option>
                        {% endfor %}
					</select><br/><br/>
					
                    <input type="button" name="btnchangeTarget" onClick="javascript: changeTarget(targetprofile.value);" 
						style="padding: 1px 3px 1px 3px; font-size: 15px;" value="Update Target" />

                    <input type="button" id="btnCalcSalts" name="btnCalcSalts" onClick="javascript: calc_salts();" 
						style="padding: 1px 3px 1px 3px; font-size: 15px;" value="Calculate Salts"/>
                </td>
			</tr>
	</table>
	<br/>
    <hr/>
	<table class="calc waterchemistrycalc">
		<tr>
			<td colspan="8" class="separator"><h2>Water Chemistry - Ion Levels (ppm or mg/L)</h2></td>
		</tr>
        <tr>
            <td class="ionname" value=""><h3>Target Profile</h3></td>
            <td colspan="3"><input type="text" id="selectedProfile" name="selectedProfile" value="{{ ah_data.form_data.selectedProfile }}" style="width: 200px" /></td>
        </tr>
		<tr>
			<td>&nbsp;</td>
			<th><div class="ionname">Ca<sup>+2</sup></div></th>
			<th><div class="ionname">Mg<sup>+2</sup></div></th>
			<th><div class="ionname">SO<sub>4</sub><sup>-2</sup></div></th>
			<th><div class="ionname">Na<sup>+</sup></div></th>
			<th><div class="ionname">Cl<sup>-</sup></div></th>
			<th><div class="ionname">HCO<sub>3</sub><sup>-</sup></div></th>
		</tr>
        <!--
		<tr>
			<th>4. Source Minerals:</th>
			<td><input type="number" step="any" min="0" name="source0" value="0" maxlength="5" style="width: 50px" onChange="javascript: updateAll();" /></td>
			<td><input type="number" step="any" min="0" name="source1" value="0" maxlength="5" style="width: 50px" onChange="javascript: updateAll();" /></td>
			<td><input type="number" step="any" min="0" name="source2" value="0" maxlength="5" style="width: 50px" onChange="javascript: updateAll();" /></td>
			<td><input type="number" step="any" min="0" name="source3" value="0" maxlength="5" style="width: 50px" onChange="javascript: updateAll();" /></td>
			<td><input type="number" step="any" min="0" name="source4" value="0" maxlength="5" style="width: 50px" onChange="javascript: updateAll();" /></td>
			<td><input type="number" step="any" min="0" name="source5" value="0" maxlength="5" style="width: 50px" onChange="javascript: updateAll();" /></td>
			<td><div id="source6" class="infodiv">-</div></td>
		</tr>
		<tr>
			<th>4a. Diluted Levels:</th>
			<td><div id="diluted0" class="infodiv">-</div></td>
			<td><div id="diluted1" class="infodiv">-</div></td>
			<td><div id="diluted2" class="infodiv">-</div></td>
			<td><div id="diluted3" class="infodiv">-</div></td>
			<td><div id="diluted4" class="infodiv">-</div></td>
			<td><div id="diluted5" class="infodiv">-</div></td>
			<td><div id="diluted6" class="infodiv">-</div></td>
		</tr>
        -->
		<tr>
			<th>Target Minerals:</th>
			<td><input type="text" step="any" min="0" id="targetCa" name="targetCa" value="{{ ah_data.form_data.targetCa }}" maxlength="4" style="width: 50px" onChange="javascript: updateDiffs();" /></td>
			<td><input type="text" step="any" min="0" id="targetMg" name="targetMg" value="{{ ah_data.form_data.targetMg }}" maxlength="4" style="width: 50px" onChange="javascript: updateDiffs();" /></td>
			<td><input type="text" step="any" min="0" id="targetSO4" name="targetSO4" value="{{ ah_data.form_data.targetSO4 }}" maxlength="4" style="width: 50px" onChange="javascript: updateDiffs();" /></td>
			<td><input type="text" step="any" min="0" id="targetNa" name="targetNa" value="{{ ah_data.form_data.targetNa }}" maxlength="4" style="width: 50px" onChange="javascript: updateDiffs();" /></td>
			<td><input type="text" step="any" min="0" id="targetCl" name="targetCl" value="{{ ah_data.form_data.targetCl }}" maxlength="4" style="width: 50px" onChange="javascript: updateDiffs();" /></td>
			<td><input type="text" step="any" min="0" id="targetHCO3" name="targetHCO3" value="{{ ah_data.form_data.targetHCO3 }}" maxlength="4" style="width: 50px" onChange="javascript: updateDiffs();" /></td>
		</tr>
		<tr>
			<th>Adjustments From Salts:</th>
			<td><input type="text" step="any" min="0" id="saltsCa" name="saltsCa" value="{{ ah_data.salts.saltsCa }}" maxlength="4" style="width: 50px" /></td>
			<td><input type="text" step="any" min="0" id="saltsMg" name="saltsMg" value="{{ ah_data.salts.saltsMg }}" maxlength="4" style="width: 50px" /></td>
			<td><input type="text" step="any" min="0" id="saltsSO4" name="saltsSO4" value="{{ ah_data.salts.saltsSO4 }}" maxlength="4" style="width: 50px" /></td>
			<td><input type="text" step="any" min="0" id="saltsNa" name="saltsNa" value="{{ ah_data.salts.saltsNa }}" maxlength="4" style="width: 50px" /></td>
			<td><input type="text" step="any" min="0" id="saltsCl" name="saltsCl" value="{{ ah_data.salts.saltsCl }}" maxlength="4" style="width: 50px" /></td>
			<td><input type="text" step="any" min="0" id="saltsHCO3" name="saltsHCO3" value="{{ ah_data.salts.saltsHCO3 }}" maxlength="4" style="width: 50px" /></td>

<!-- 			<td><div id="saltsCa" class="infodiv">{{ ah_data.salts.saltsCa }}</div></td>
			<td><div id="saltsMg" class="infodiv">{{ ah_data.salts.saltsMg }}</div></td>
			<td><div id="saltsSO4" class="infodiv">{{ ah_data.salts.saltsSO4 }}</div></td>
			<td><div id="saltsNa" class="infodiv">{{ ah_data.salts.saltsNa }}</div></td>
			<td><div id="saltsCl" class="infodiv">{{ ah_data.salts.saltsCl }}</div></td>
			<td><div id="saltsHCO3" class="infodiv">{{ ah_data.salts.saltsHCO3 }}</div></td> -->
		</tr>
        <!--
		<tr>
			<th>7. Adjusted Water:</th>
			<td><div id="adjusted0" class="infodiv">-</div></td>
			<td><div id="adjusted1" class="infodiv">-</div></td>
			<td><div id="adjusted2" class="infodiv">-</div></td>
			<td><div id="adjusted3" class="infodiv">-</div></td>
			<td><div id="adjusted4" class="infodiv">-</div></td>
			<td><div id="adjusted5" class="infodiv">-</div></td>
			<td><div id="adjusted6" class="infodiv">-</div></td>
		</tr>
        -->
		<tr>
			<th>Difference:</th>
			<td><div id="diffCa" class="infodiv">{{ ah_data.salts.diffCa }}</div></td>
			<td><div id="diffMg" class="infodiv">{{ ah_data.salts.diffMg }}</div></td>
			<td><div id="diffSO4" class="infodiv">{{ ah_data.salts.diffSO4 }}</div></td>
			<td><div id="diffNa" class="infodiv">{{ ah_data.salts.diffNa }}</div></td>
			<td><div id="diffCl" class="infodiv">{{ ah_data.salts.diffCl }}</div></td>
			<td><div id="diffHCO3" class="infodiv">{{ ah_data.salts.diffHCO3 }}</div></td>
		</tr>
    </table>
    <br/>
    <hr/>
    <table class="tableLayout">

		<tr>
			<td colspan="8" class="separator"><h2>Brewing Salt Additions&nbsp;&nbsp;&nbsp;</h2></td>
		</tr>
		<tr>
			<th>Chalk CaCO<sub>3</sub></th>
			<td colspan="2"><input type="number" step="any" min="0" id="txtCaCO3" name="txtCaCO3" value="{{ ah_data.calc_results.txtCaCO3 }}" maxlength="5" style="width: 100px" onChange="javascript: adjustments();" /> grams</td>
		</tr>

		<tr>
			<th>Baking Soda NaHCO<sub>3</sub></th>
			<td colspan="2"><input type="number" step="any" min="0" id="txtNaHCO3" name="txtNaHCO3" value="{{ ah_data.calc_results.txtNaHCO3 }}" maxlength="5" style="width: 100px" onChange="javascript: adjustments();" /> grams</td>
		</tr>

		<tr>
			<th>Gypsum CaSO<sub>4</sub></th>
			<td colspan="2"><input type="number" step="any" min="0" id="txtCaSO4" name="txtCaSO4" value="{{ ah_data.calc_results.txtCaSO4 }}" maxlength="5" style="width: 100px" onChange="javascript: adjustments();" /> grams</td>
		</tr>
		<tr>
			<th>Calcium Chloride CaCl<sub>2</sub></th>
			<td colspan="2"><input type="number" step="any" min="0" id="txtCaCl2" name="txtCaCl2" value="{{ ah_data.calc_results.txtCaCl2 }}" maxlength="5" style="width: 100px" onChange="javascript: adjustments();" /> grams</td>
		</tr>

		<tr>
			<th>Epsom Salt MgSO<sub>4</sub></th>
			<td colspan="2"><input type="number" step="any" min="0" id="txtMgSO4" name="txtMgSO4" value="{{ ah_data.calc_results.txtMgSO4 }}" maxlength="5" style="width: 100px" onChange="javascript: adjustments();" /> grams</td>
		</tr>
		<tr>
			<th>Canning Salt NaCl</th>
			<td colspan="2"><input type="number" step="any" min="0" id="txtNaCl" name="txtNaCl" value="{{ ah_data.calc_results.txtNaCl }}" maxlength="5" style="width: 100px" onChange="javascript: adjustments();" /> grams</td>
		</tr>
	</table>
</form>

{% endblock %}